name: Build

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ZIG_VERSION: "master"

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
      - run: zig fmt --exclude patches --ast-check --check .

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        target: [esp32, esp32s2, esp32s3, esp32c3, esp32h2, esp32c6]
        idf-version: [v5.5, v6.0-beta2]
    steps:
      - uses: actions/checkout@main
      
      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install ESP-IDF prerequisites (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Install ESP-IDF prerequisites (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install cmake ninja dfu-util

      - name: Cache ESP-IDF
        id: cache-idf
        uses: actions/cache@main
        with:
          path: ~/esp/esp-idf
          key: ${{ runner.os }}-esp-idf-${{ matrix.idf-version }}

      - name: Clone ESP-IDF
        if: steps.cache-idf.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/esp
          cd ~/esp
          git clone -b ${{ matrix.idf-version }} --recursive https://github.com/espressif/esp-idf.git

      - name: Install ESP-IDF (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd ~/esp/esp-idf
          ./install.sh ${{ matrix.target }}

      - name: Install ESP-IDF (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          cd %USERPROFILE%\esp\esp-idf
          install.bat ${{ matrix.target }}

      - name: Build (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          . ~/esp/esp-idf/export.sh
          idf.py set-target ${{ matrix.target }}
          idf.py build

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          cd %USERPROFILE%\esp\esp-idf
          call export.bat
          cd %GITHUB_WORKSPACE%
          idf.py set-target ${{ matrix.target }}
          idf.py build
